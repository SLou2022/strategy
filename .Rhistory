vixy_signal <- "Market risk high & VIXY rising â†’ consider hedge."
} else if (risk_off) {
vixy_signal <- "Market risk high, but VIXY not trending up."
} else {
vixy_signal <- "Market normal â†’ no hedge needed."
}
} else {
vixy_signal <- "Insufficient VIXY data."
}
# ============================================
# 7. å»ºè®®ç»„åˆ
# ============================================
suggested_portfolio <- unique(c(forced_hold, extra_picks))
risk_comment <- if (risk_off)
"RISK_OFF â€” SPY < 200-day MA" else
"RISK_ON â€” SPY â‰¥ 200-day MA"
if (rebalance_allowed) {
rebalance_comment <- "Rebalance allowed today."
writeLines(as.character(today), rebalance_file)
} else {
rebalance_comment <- glue("Rebalance NOT allowed â€” wait {rebalance_day_gap - days_since_reb} more day(s).")
}
# ============================================
# 8. è®°å½•æ—¥å¿—
# ============================================
log_entry <- tibble(
date = today,
picks = paste(suggested_portfolio, collapse = ", "),
risk_off = risk_off,
hedge = vixy_signal,
rebalance_allowed = rebalance_allowed
)
if (file.exists(log_file)) {
old <- read_csv(log_file, show_col_types = FALSE)
write_csv(bind_rows(old, log_entry), log_file)
} else {
write_csv(log_entry, log_file)
}
# ============================================
# 9. ç”Ÿæˆæ–‡æœ¬ signal_text
# ============================================
signal_text <- glue("
ğŸ”’ Forced holdings: {paste(forced_hold, collapse=', ')}
ğŸ“ˆ Extra picks: {ifelse(length(extra_picks)==0, 'None', paste(extra_picks, collapse=', '))}
ğŸ§º Suggested portfolio:
{paste(suggested_portfolio, collapse=', ')}
ğŸ›¡ Hedge Signal:
{vixy_signal}
âš  Market Risk:
SPY price: {round(spy_price,2)}
SPY MA200: {round(spy_sma200,2)}
State: {risk_comment}
ğŸ”„ Rebalance:
Days since last: {days_since_reb}
{rebalance_comment}
ğŸ“ Log saved: {log_file}
")
# ============================================
# 10. ç”Ÿæˆ HTML
# ============================================
html_file <- file.path(repo_dir, "strategy.html")
html_content <- glue("
<html>
<head>
<meta charset='UTF-8'>
<title>Daily Strategy</title>
<style>
body {{
background: #f5f5f5;
font-family: Arial;
padding: 40px;
}}
.box {{
background: white;
padding: 30px;
border-radius: 10px;
max-width: 900px;
margin: auto;
font-size: 16px;
line-height: 1.7;
box-shadow: 0px 3px 15px rgba(0,0,0,0.15);
}}
pre {{
white-space: pre-wrap;
font-family: Consolas;
}}
</style>
</head>
<body>
<div class='box'>
<h2>ğŸ“Š Strategy Signal â€” {today}</h2>
<pre>{signal_text}</pre>
</div>
</body>
</html>
")
writeLines(html_content, html_file)
cat("HTML é¡µé¢å·²ç”Ÿæˆï¼š", html_file, "\n")
# ============================================
# 11. è‡ªåŠ¨ä¸Šä¼  GitHub
# ============================================
setwd(repo_dir)
system("git add .")
system("git commit -m \"auto update\"")
system("git push")
cat("ç­–ç•¥å·²æ¨é€åˆ° GitHub Pagesï¼\n")
cat("æ‰‹æœºæŸ¥çœ‹ç½‘å€ï¼š https://shuhang2022.github.io/strategy/strategy.html\n")
gc()
##############################################
# Dynamic Strategy + HTML + Charts + GitHub Pages
# Author: Shuhang
##############################################
library(tidyverse)
library(tidyquant)
library(glue)
library(zoo)
library(readr)
library(lubridate)
# ============================================
# 0. è·¯å¾„è®¾ç½®
# ============================================
base_dir    <- "C:/Users/lsh51/Desktop/QIAN"
repo_dir    <- file.path(base_dir, "strategy")    # GitHub ä»“åº“ç›®å½•
log_file    <- file.path(base_dir, "strategy_log.csv")
rebalance_file <- file.path(base_dir, "last_rebalance_date.txt")
setwd(base_dir)
today <- Sys.Date()
# ============================================
# 1. ç­–ç•¥å‚æ•°
# ============================================
forced_hold         <- c("VT", "AOR", "PLTR", "VYM", "SPY")
hedge_ticker        <- "VIXY"
max_total_positions <- 8          # æ€»æŒä»“ä¸Šé™ï¼ˆå¼ºåˆ¶æŒä»“+åŠ¨é‡ç¥¨ï¼‰
rebalance_day_gap   <- 7          # ä¸¤æ¬¡è°ƒä»“æœ€å°‘é—´éš”å¤©æ•°
# ============================================
# 2. è¯»å–ä¸Šæ¬¡è°ƒä»“æ—¶é—´
# ============================================
if (file.exists(rebalance_file)) {
last_reb_day <- as.Date(readLines(rebalance_file)[1])
} else {
last_reb_day <- today - 999     # ç¬¬ä¸€æ¬¡é»˜è®¤å¾ˆä¹…ä»¥å‰è°ƒè¿‡ä»“
}
days_since_reb    <- as.integer(today - last_reb_day)
rebalance_allowed <- days_since_reb >= rebalance_day_gap
# ============================================
# 3. ä¸‹è½½è¡Œæƒ…æ•°æ®
# ============================================
sp500_syms <- tq_index("SP500")$symbol
universe_syms <- unique(c(sp500_syms, forced_hold, hedge_ticker, "SPY"))
prices <- tq_get(
universe_syms,
from = today - 400,
to   = today,
get  = "stock.prices"
)
# ============================================
# 4. SPY 200 æ—¥å‡çº¿ â†’ é£é™©åˆ¤å®š
# ============================================
spy <- prices %>%
filter(symbol == "SPY") %>%
arrange(date)
spy_ma200 <- spy %>%
mutate(ma200 = zoo::rollmean(adjusted, 200, fill = NA, align = "right"))
spy_latest <- tail(spy_ma200, 1)
spy_price  <- as.numeric(spy_latest$adjusted)
spy_sma200 <- as.numeric(spy_latest$ma200)
risk_off <- spy_price < spy_sma200
# ============================================
# 5. åŠ¨é‡ + ä½æ³¢é€‰è‚¡ï¼ˆä» S&P500 é‡Œé€‰ï¼‰
# ============================================
rank_data <- prices %>%
arrange(date) %>%
group_by(symbol) %>%
mutate(
ret_90 = adjusted / dplyr::lag(adjusted, 90) - 1,
sd_30  = zoo::rollapply(adjusted, 30, sd, fill = NA, align = "right")
) %>%
summarise(
ret_90 = dplyr::last(ret_90),
sd_30  = dplyr::last(sd_30),
.groups = "drop"
) %>%
drop_na()
extra_slots <- max(max_total_positions - length(forced_hold), 0)
candidates <- rank_data %>%
filter(
symbol %in% sp500_syms,
!symbol %in% forced_hold,
symbol != hedge_ticker
) %>%
arrange(desc(ret_90), sd_30) %>%
slice_head(n = extra_slots)
extra_picks <- candidates$symbol
# ============================================
# 6. VIXY å¯¹å†²ä¿¡å·
# ============================================
vixy_df <- prices %>%
filter(symbol == hedge_ticker) %>%
arrange(date)
if (nrow(vixy_df) > 20) {
px_last <- tail(vixy_df$adjusted, 1)
px_20   <- vixy_df$adjusted[nrow(vixy_df) - 20]
vixy_up <- px_last > px_20
if (risk_off && vixy_up) {
vixy_signal <- "Market risk high & VIXY rising â†’ consider hedge."
} else if (risk_off) {
vixy_signal <- "Market risk high, but VIXY not clearly trending up."
} else {
vixy_signal <- "Market normal â†’ hedge usually not needed."
}
} else {
vixy_signal <- "Insufficient VIXY data."
}
# ============================================
# 7. å»ºè®®ç»„åˆ
# ============================================
suggested_portfolio <- unique(c(forced_hold, extra_picks))
risk_comment <- if (risk_off) {
"RISK_OFF â€” SPY < 200-day MA"
} else {
"RISK_ON â€” SPY â‰¥ 200-day MA"
}
if (rebalance_allowed) {
rebalance_comment <- "Rebalance allowed today."
writeLines(as.character(today), rebalance_file)
} else {
rebalance_comment <- glue("Rebalance NOT allowed â€” wait {rebalance_day_gap - days_since_reb} more day(s).")
}
# ============================================
# 8. è®°å½•æ—¥å¿—
# ============================================
log_entry <- tibble(
date              = today,
picks             = paste(suggested_portfolio, collapse = ", "),
risk_off          = risk_off,
hedge_msg         = vixy_signal,
rebalance_allowed = rebalance_allowed
)
if (file.exists(log_file)) {
old <- read_csv(log_file, show_col_types = FALSE)
write_csv(bind_rows(old, log_entry), log_file)
} else {
write_csv(log_entry, log_file)
}
# ============================================
# 9. æ—¶é—´ä¸ç¾è‚¡å¼€å¸‚çŠ¶æ€ï¼ˆåŒ—äº¬æ—¶é—´ + çº½çº¦æ—¶é—´ï¼‰
# ============================================
now_utc <- now(tzone = "UTC")
ny_time   <- with_tz(now_utc, "America/New_York")
bj_time   <- with_tz(now_utc, "Asia/Shanghai")
ny_time_str <- format(ny_time, "%Y-%m-%d %H:%M:%S")
bj_time_str <- format(bj_time, "%Y-%m-%d %H:%M:%S")
# ç®€å•çš„ç¾è‚¡å¼€å¸‚çŠ¶æ€ï¼ˆä¸è€ƒè™‘å‡æœŸï¼Œåªçœ‹å‘¨å‡ +æ—¶é—´ï¼‰
ny_wday   <- wday(ny_time, week_start = 1)  # 1=å‘¨ä¸€,...,7=å‘¨æ—¥
ny_hour   <- hour(ny_time)
ny_min    <- minute(ny_time)
ny_total_min <- ny_hour * 60 + ny_min
is_weekday <- ny_wday <= 5
if (!is_weekday) {
us_market_status <- "US Market Closed (Weekend)."
} else if (ny_total_min < (9*60 + 30)) {
us_market_status <- "US Market: Pre-Market (Regular session not open yet)."
} else if (ny_total_min <= (16*60)) {
us_market_status <- "US Market: Regular Trading Hours (Open)."
} else {
us_market_status <- "US Market: After Hours (Regular session closed)."
}
# ============================================
# 10. ç­–ç•¥æ–‡æœ¬ signal_text
# ============================================
signal_text <- glue("
ğŸ”’ Forced holdings: {paste(forced_hold, collapse=', ')}
ğŸ“ˆ Extra picks (momentum + low vol): {ifelse(length(extra_picks)==0, 'None', paste(extra_picks, collapse=', '))}
ğŸ§º Suggested portfolio:
{paste(suggested_portfolio, collapse=', ')}
ğŸ›¡ Hedge Signal:
{vixy_signal}
âš  Market Risk:
SPY price : {round(spy_price, 2)}
SPY MA200 : {round(spy_sma200, 2)}
State     : {risk_comment}
ğŸ”„ Rebalance:
Days since last: {days_since_reb}
{rebalance_comment}
ğŸ•’ Time Info:
Beijing time : {bj_time_str}
New York time: {ny_time_str}
US Market    : {us_market_status}
")
cat(signal_text, "\n")
# ============================================
# 11. ç”ŸæˆæŒä»“å’ŒåŠ¨æ€ picks çš„èµ°åŠ¿å›¾ + ç®€å•é¢„æµ‹
# ============================================
# ç”»å›¾ä½¿ç”¨æœ€è¿‘ 365 å¤©æ•°æ® + æœªæ¥ 7 å¤©çº¿æ€§å¤–æ¨é¢„æµ‹ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
hist_days      <- 365
forecast_days  <- 7
tickers_to_plot <- unique(c(forced_hold, extra_picks))
price_hist <- tq_get(
tickers_to_plot,
from = today - hist_days,
to   = today,
get  = "stock.prices"
)
# ç¡®ä¿ repo_dir å­˜åœ¨
if (!dir.exists(repo_dir)) dir.create(repo_dir, recursive = TRUE)
charts_section <- c()
for (sym in tickers_to_plot) {
df_sym <- price_hist %>%
filter(symbol == sym) %>%
arrange(date)
if (nrow(df_sym) < 30) next  # å¤ªå°‘å°±ä¸ç”»
# ç”¨æœ€è¿‘ 60 å¤©æ‹Ÿåˆç®€å•çº¿æ€§è¶‹åŠ¿
df_fit <- tail(df_sym, 60)
df_fit <- df_fit %>%
mutate(t = as.numeric(date))
model <- try(lm(adjusted ~ t, data = df_fit), silent = TRUE)
if (inherits(model, "try-error")) next
# æœªæ¥ 7 å¤©é¢„æµ‹
last_date <- max(df_sym$date)
future_dates <- seq(last_date + 1, by = "1 day", length.out = forecast_days)
df_future <- tibble(
date = future_dates,
t    = as.numeric(future_dates)
)
df_future$pred <- predict(model, newdata = df_future)
# åˆå¹¶å†å² + é¢„æµ‹
df_plot_hist <- df_sym %>%
select(date, adjusted) %>%
mutate(type = "History")
df_plot_future <- df_future %>%
select(date, adjusted = pred) %>%
mutate(type = "Forecast")
df_plot <- bind_rows(df_plot_hist, df_plot_future)
p <- ggplot(df_plot, aes(x = date, y = adjusted, color = type)) +
geom_line(size = 0.7) +
scale_color_manual(values = c("History" = "#2c7bb6", "Forecast" = "#d7191c")) +
labs(
title = paste0(sym, " â€” Price & Simple Trend Forecast"),
x = "", y = "Adjusted Price"
) +
theme_minimal(base_size = 11) +
theme(
legend.position = "bottom",
plot.title = element_text(face = "bold")
)
img_name <- paste0("chart_", sym, ".png")
img_path <- file.path(repo_dir, img_name)
ggsave(img_path, p, width = 7, height = 3.5, dpi = 120)
charts_section <- c(
charts_section,
glue("<h3>{sym}</h3><img src=\"{img_name}\" style=\"max-width:100%;border-radius:8px;margin-bottom:20px;\">")
)
}
charts_html_block <- paste(charts_section, collapse = "\n")
# ============================================
# 12. ç”Ÿæˆ HTML é¡µé¢ï¼ˆç¾åŒ–ï¼‰
# ============================================
html_file <- file.path(repo_dir, "strategy.html")
html_content <- glue("
<html>
<head>
<meta charset='UTF-8'>
<title>Daily Strategy</title>
<style>
body {{
background: #f0f2f5;
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
padding: 30px;
}}
.container {{
max-width: 960px;
margin: auto;
}}
.card {{
background: #ffffff;
border-radius: 12px;
box-shadow: 0 4px 12px rgba(0,0,0,0.08);
padding: 24px 28px;
margin-bottom: 24px;
}}
h1, h2, h3 {{
margin-top: 0;
}}
h1 {{
font-size: 24px;
color: #1f2933;
}}
h2 {{
font-size: 20px;
color: #1f4f82;
}}
pre {{
white-space: pre-wrap;
font-family: Consolas, 'Fira Code', monospace;
font-size: 14px;
line-height: 1.7;
}}
.badge {{
display: inline-block;
padding: 4px 10px;
border-radius: 999px;
font-size: 12px;
color: #fff;
margin-right: 6px;
}}
.badge-riskon {{ background: #2c7bb6; }}
.badge-riskoff {{ background: #d9534f; }}
.badge-hedge {{ background: #6c757d; }}
.time-row {{
display: flex;
flex-wrap: wrap;
gap: 12px;
font-size: 14px;
}}
.time-pill {{
background: #f3f4f6;
border-radius: 999px;
padding: 6px 12px;
}}
.footer {{
font-size: 12px;
color: #6b7280;
text-align: center;
margin-top: 20px;
}}
</style>
</head>
<body>
<div class='container'>
<div class='card'>
<h1>ğŸ“Š Daily Strategy â€” {today}</h1>
<div class='time-row'>
<div class='time-pill'>ğŸ•’ Beijing: {bj_time_str}</div>
<div class='time-pill'>ğŸ•’ New York: {ny_time_str}</div>
<div class='time-pill'>ğŸ“ˆ {us_market_status}</div>
</div>
<br/>
<div>
<span class='badge {ifelse(risk_off, \"badge-riskoff\", \"badge-riskon\")}'>{risk_comment}</span>
<span class='badge badge-hedge'>Hedge: {vixy_signal}</span>
</div>
</div>
<div class='card'>
<h2>Strategy Text</h2>
<pre>{signal_text}</pre>
</div>
<div class='card'>
<h2>Holdings & Picks Charts (Last {hist_days} days + {forecast_days}-day trend)</h2>
{charts_html_block}
</div>
<div class='footer'>
Auto-generated by R Â· Updated at {bj_time_str} (Beijing Time) Â· Not investment advice.
</div>
</div>
</body>
</html>
")
writeLines(html_content, html_file)
cat("âœ… HTML é¡µé¢å·²ç”Ÿæˆï¼š", html_file, "\n")
# ============================================
# 13. è‡ªåŠ¨ Git æ¨é€åˆ° GitHubï¼ˆæ›´æ–°ç½‘é¡µï¼‰
# ============================================
setwd(repo_dir)
system("git add .")
system("git commit -m \"auto update\"")
system("git push")
cat("âœ… å·²æ¨é€åˆ° GitHub Pagesï¼\n")
cat("ğŸŒ ç½‘é¡µåœ°å€ï¼š https://shuhang2022.github.io/strategy/strategy.html\n")
repo_dir
list.files(repo_dir)
setwd("C:/Users/lsh51/Desktop/QIAN/strategy")
cat("==== git status ====\n")
system("git status")
cat("\n==== git add ====\n")
system("git add .")
cat("\n==== git commit ====\n")
system("git commit -m \"auto test commit\"")
cat("\n==== git push ====\n")
system("git push")
setwd("C:/Users/lsh51/Desktop/QIAN/strategy")
git_path <- "\"C:/Program Files/Git/cmd/git.exe\""
system(paste(git_path, "status"))
system(paste(git_path, "add ."))
system(paste(git_path, "commit -m \"push test\""))
system(paste(git_path, "push"))
setwd("C:/Users/lsh51/Desktop/QIAN/strategy")
git_path <- "\"C:/Program Files/Git/cmd/git.exe\""
system(paste(git_path, "add ."))
system(paste(git_path, "commit -m \"push test 2\""))
system(paste(git_path, "push"))
setwd("C:/Users/lsh51/Desktop/QIAN/strategy")
git_path <- "\"C:/Program Files/Git/cmd/git.exe\""
system(paste(git_path, "add ."))
system(paste(git_path, "commit -m \"push test 2\""))
system(paste(git_path, "push"))
setwd("C:/Users/lsh51/Desktop/QIAN/strategy")
git_path <- "\"C:/Program Files/Git/cmd/git.exe\""
system(paste(git_path, "add ."))
system(paste(git_path, "commit -m \"push test 2\""))
system(paste(git_path, "push"))
setwd("C:/Users/lsh51/Desktop/QIAN/strategy")
git_path <- "\"C:/Program Files/Git/cmd/git.exe\""
system(paste(git_path, "add ."))
system(paste(git_path, "commit -m \"push test 2\""))
system(paste(git_path, "push"))
setwd("C:/Users/lsh51/Desktop/QIAN/strategy")
git_path <- "\"C:/Program Files/Git/cmd/git.exe\""
system(paste(git_path, "add ."))
system(paste(git_path, "commit -m \"push test 3\""))
system(paste(git_path, "push"))
R.home()
file.path(R.home("bin"), "Rscript.exe")
